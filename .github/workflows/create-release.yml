name: Create release PR

on:
  workflow_dispatch:
    inputs:
      version:
        required: true
        type: choice
        description: Which version should be published?
        options:
          - patch
          - minor
          - major
          - prepatch
          - preminor
          - premajor
          - prerelease
      tag:
        required: true
        type: choice
        description: Which npm tag should this be published to?
        options:
          - latest
          - next
      preid:
        type: choice
        description: Which prerelease identifier should be used? This is only needed when version is "prepatch", "preminor", "premajor", or "prerelease".
        options:
          - ""
          - alpha
          - beta
          - rc
          - next

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Calculate new version
        id: version
        run: |
          # Read current version from manifest
          CURRENT_VERSION=$(jq -r '."."' .release-please-manifest.json)
          echo "Current version: $CURRENT_VERSION"

          # Install semver for version calculation
          npm install -g semver

          # Calculate new version based on input
          NEW_VERSION=$(semver -i ${{ inputs.version }} $CURRENT_VERSION)
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Create release commit
        run: |
          git config user.name "ambitiondev-release-bot[bot]"
          git config user.email "ambitiondev-release-bot[bot]@users.noreply.github.com"
          git commit --allow-empty -m "chore: release ${{ steps.version.outputs.new_version }}" -m "Release-As: ${{ steps.version.outputs.new_version }}"
          git push
